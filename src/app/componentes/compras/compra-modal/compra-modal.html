@if (visible) {
<div class="modal-overlay d-flex align-items-center justify-content-center">
    <div class="modal-content border-0 shadow rounded-4 overflow-hidden" [style.max-width]="'1000px'">
        <!-- Header -->
        <div class="modal-header border-0 p-3 d-flex justify-content-center position-relative shadow-sm bg-white">
            <h2 class="modal-title fw-bold m-0 text-dark">Compra de productos</h2>
            <button type="button" class="btn-close-custom position-absolute end-0 top-50 translate-middle-y me-3"
                (click)="onCerrar()">
                <i class="bi bi-x-circle-fill fs-2" [style.color]="colorSistema"></i>
            </button>
        </div>

        <div class="modal-body p-4 bg-white">
            <!-- Proveedor Section -->
            <div class="row mb-4 align-items-end">
                <div class="col-md-5">
                    <label class="form-label fw-bold mb-1">Nombre<span class="text-danger">*</span></label>
                    <div class="search-box">
                        <input type="text" class="form-control input-custom" placeholder="Ingrese nombre de proveedor"
                            [value]="textoBusquedaProveedor()"
                            (input)="textoBusquedaProveedor.set($any($event.target).value)">
                        <i class="bi bi-search search-icon"></i>

                        <!-- Dropdown Sugerencias Proveedor -->
                        @if (textoBusquedaProveedor() && !form.get('CodigoProveedor')?.value) {
                        <div class="search-suggestions shadow-sm">
                            @for (p of proveedoresFiltrados(); track p.CodigoProveedor) {
                            <div class="suggestion-item" (click)="seleccionarProveedor(p)">
                                {{ p.NombreProveedor }} <small class="text-muted">({{ p.NIT }})</small>
                            </div>
                            }
                            @if (proveedoresFiltrados().length === 0) {
                            <div class="suggestion-item text-muted">No se encontraron resultados</div>
                            }
                        </div>
                        }
                    </div>
                </div>
                <div class="col-auto">
                    <button class="btn btn-orange-square shadow-sm" [style.background-color]="colorSistema"
                        (click)="abrirModalProveedor()" title="Nuevo proveedor">
                        <i class="bi bi-person-plus-fill"></i>
                    </button>
                </div>
            </div>

            <!-- Producto Selection Section -->
            <div class="row mb-4 g-2">
                <div class="col-md-5">
                    <label class="form-label fw-bold mb-1">Producto</label>
                    <div class="search-box">
                        <input type="text" class="form-control input-custom" placeholder="Nombre de producto"
                            [value]="textoBusquedaProducto()"
                            (input)="textoBusquedaProducto.set($any($event.target).value)">
                        <i class="bi bi-search search-icon"></i>

                        <!-- Dropdown Sugerencias Producto -->
                        @if (textoBusquedaProducto() && !itemForm.get('CodigoProducto')?.value) {
                        <div class="search-suggestions shadow-sm">
                            @for (p of productosFiltrados(); track p.CodigoProducto) {
                            <div class="suggestion-item" (click)="seleccionarProducto(p)">
                                {{ p.Producto }} <small class="text-muted">({{ p.NombreCategoriaProducto }})</small>
                            </div>
                            }
                        </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Inputs Row (Top Table Row) -->
            <div class="row g-2 mb-3 mt-2" [formGroup]="itemForm">
                <div class="col">
                    <label class="form-label fw-bold small text-muted mb-1">Categoría</label>
                    <input type="text" class="form-control input-custom-flat" formControlName="NombreCategoria">
                </div>
                <div class="col">
                    <label class="form-label fw-bold small text-muted mb-1">Producto</label>
                    <input type="text" class="form-control input-custom-flat" formControlName="NombreProducto">
                </div>
                <div class="col">
                    <label class="form-label fw-bold small text-muted mb-1">Presentación</label>
                    <input type="text" class="form-control input-custom-flat" formControlName="NombrePresentacion">
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold small text-muted mb-1">Precio</label>
                    <div class="input-group-custom">
                        <span class="prefix">Q</span>
                        <input type="number" class="form-control input-custom-flat" formControlName="Precio">
                    </div>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold small text-muted mb-1">Cantidad</label>
                    <div class="input-group-custom">
                        <input type="number" class="form-control input-custom-flat" formControlName="Cantidad">
                    </div>
                </div>
                <div class="col-auto d-flex align-items-end">
                    <button class="btn btn-orange-square shadow-sm mb-1" [style.background-color]="colorSistema"
                        (click)="agregarItemALista()">
                        <i class="bi bi-plus fs-4"></i>
                    </button>
                </div>
            </div>

            <!-- Detalle Table -->
            <div class="table-container-custom shadow-sm mb-4">
                <table class="table align-middle m-0">
                    <thead class="text-white" [style.background-color]="colorSistema">
                        <tr>
                            <th width="50">No.</th>
                            <th>Categoria</th>
                            <th>Producto</th>
                            <th>Presentación</th>
                            <th width="120">Precio</th>
                            <th width="100">Cantidad</th>
                            <th width="100" class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (item of items.controls; track $index) {
                        <tr>
                            <td class="text-muted">{{ $index + 1 | number:'2.0-0' }}</td>
                            <td>{{ item.get('NombreCategoria')?.value }}</td>
                            <td>{{ item.get('NombreProducto')?.value }}</td>
                            <td>{{ item.get('NombrePresentacion')?.value }}</td>
                            <td class="fw-bold">Q {{ item.get('Precio')?.value | number:'1.2-2' }}</td>
                            <td class="fw-bold">{{ item.get('Cantidad')?.value }}</td>
                            <td class="text-center">
                                <div class="d-flex justify-content-center gap-2">
                                    <button class="btn-icon-action" title="Editar" (click)="editarItem($index)">
                                        <i class="bi bi-pencil-square fs-5"></i>
                                    </button>
                                    <button class="btn-icon-action text-danger" (click)="eliminarItem($index)"
                                        title="Eliminar">
                                        <i class="bi bi-trash-fill fs-5"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        }
                        @if (items.length === 0) {
                        <tr>
                            <td colspan="7" class="text-center py-4 text-muted">No hay productos agregados</td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Footer Actions -->
            <div class="d-flex flex-wrap justify-content-end align-items-center gap-3 mt-4" [formGroup]="form">

                <!-- Custom Metodo de Pago Dropdown -->
                <div class="custom-dropdown-container">
                    <div class="custom-dropdown-header shadow-sm" [style.background-color]="colorSistema"
                        (click)="mostrarMetodoPago.set(!mostrarMetodoPago()); mostrarMedioPago.set(false); $event.stopPropagation()">
                        <span>{{ form.get('MetodoPago')?.value || 'Método de pago' }}</span>
                        <i class="bi bi-caret-down-fill text-white ms-2"></i>
                    </div>
                    @if (mostrarMetodoPago()) {
                    <ul class="custom-dropdown-menu shadow">
                        <li class="dropdown-header-only">Método de pago</li>
                        @for (m of metodosPago; track m) {
                        <li (click)="form.get('MetodoPago')?.setValue(m); mostrarMetodoPago.set(false)">{{ m }}</li>
                        }
                    </ul>
                    }
                </div>

                <!-- Custom Medio de Pago Dropdown -->
                <div class="custom-dropdown-container">
                    <div class="custom-dropdown-header shadow-sm" [style.background-color]="colorSistema"
                        (click)="mostrarMedioPago.set(!mostrarMedioPago()); mostrarMetodoPago.set(false); $event.stopPropagation()">
                        <span>{{ form.get('MedioPago')?.value || 'Medio de pago' }}</span>
                        <i class="bi bi-caret-down-fill text-white ms-2"></i>
                    </div>
                    @if (mostrarMedioPago()) {
                    <ul class="custom-dropdown-menu shadow">
                        <li class="dropdown-header-only">Medio de pago</li>
                        @for (m of mediosPago; track m) {
                        <li (click)="form.get('MedioPago')?.setValue(m); mostrarMedioPago.set(false)">{{ m }}</li>
                        }
                    </ul>
                    }
                </div>

                <button class="btn btn-save-orange shadow" [style.background-color]="colorSistema" (click)="onGuardar()"
                    [disabled]="cargando()">
                    @if (cargando()) {
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    } @else {
                    <i class="bi bi-box-arrow-in-down"></i>
                    }
                    Guardar
                </button>
            </div>
        </div>
    </div>
</div>
}

<app-modal-proveedor [visible]="mostrarModalProveedor()" [colorSistema]="colorSistema"
    (alCerrar)="cerrarModalProveedor()" (alGuardar)="manejarGuardarProveedor($event)">
</app-modal-proveedor>