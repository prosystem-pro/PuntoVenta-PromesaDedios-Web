<div class="materia-prima-detalle-container" [style.--color-sistema]="colorSistema">

    <div class="layout-grid" [class.edit-mode-center]="modoEdicion()">
        <!-- Columna Izquierda: Formulario -->
        <div class="col-form">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white text-center border-0 pt-4">
                    <h2 class="card-title fw-bold">
                        {{ modoEdicion() ? 'Editar materia prima' : 'Crear materia prima' }}
                    </h2>
                </div>
                <div class="card-body p-4" [formGroup]="form">
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label class="form-label">Categoría<span class="text-danger">*</span></label>
                            <div class="input-group-custom">
                                <select class="form-select" formControlName="CodigoCategoriaProducto">
                                    <option [ngValue]="null">Seleccionar</option>
                                    @for (cat of categorias(); track cat.CodigoCategoriaProducto) {
                                    <option [ngValue]="cat.CodigoCategoriaProducto">{{ cat.NombreCategoriaProducto }}
                                    </option>
                                    }
                                </select>
                                <button class="btn btn-add-mini" [style.background-color]="colorSistema"
                                    (click)="mostrarCategoriaModal.set(true)">
                                    <i class="bi bi-plus-lg"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group flex-1">
                            <label class="form-label">Producto<span class="text-danger">*</span></label>
                            <input type="text" class="form-control" placeholder="Nombre"
                                formControlName="NombreProducto">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label class="form-label">Presentación<span class="text-danger">*</span></label>
                            <div class="input-group-custom">
                                <select class="form-select" formControlName="CodigoUnidadMedida">
                                    <option [ngValue]="null">Seleccionar</option>
                                    @for (u of unidades(); track u.CodigoUnidadMedida) {
                                    <option [ngValue]="u.CodigoUnidadMedida">{{ u.NombreUnidad }}</option>
                                    }
                                </select>
                                <button class="btn btn-add-mini" [style.background-color]="colorSistema"
                                    (click)="mostrarPresentacionModal.set(true)">
                                    <i class="bi bi-plus-lg"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group flex-1">
                            <label class="form-label">Stock</label>
                            <input type="number" class="form-control" placeholder="Cantidad" formControlName="Stock"
                                [readonly]="modoEdicion()">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label class="form-label">Stock Mínimo</label>
                            <input type="number" class="form-control" placeholder="Cantidad"
                                formControlName="StockMinimo">
                        </div>
                        <div class="form-group flex-1">
                            <label class="form-label">Stock sugerido</label>
                            <input type="number" class="form-control" placeholder="Cantidad"
                                formControlName="StockSugerido">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label class="form-label">Precio compra</label>
                            <input type="number" class="form-control" placeholder="Cantidad"
                                formControlName="PrecioCompra">
                        </div>
                        <div class="form-group flex-1">
                            <label class="form-label">Codigo de barra</label>
                            <input type="text" class="form-control" placeholder="Cantidad"
                                formControlName="CodigoBarra">
                        </div>
                    </div>

                    <div class="form-row align-items-end">
                        <div class="form-group flex-1">
                            <label class="form-label">Iva</label>
                            <input type="number" class="form-control" placeholder="%" formControlName="Iva">
                        </div>
                        <div class="form-group flex-1">
                            <label class="form-label">Subir imagen</label>
                            <div class="d-flex align-items-center gap-3">
                                <button class="btn btn-upload" (click)="fileInput.click()">
                                    <i class="bi bi-upload"></i>
                                </button>
                                <input type="file" #fileInput hidden (change)="alSeleccionarImagen($event)"
                                    accept="image/*">
                                <div class="image-preview shadow-sm">
                                    @if (imagenPreview()) {
                                    <img [src]="imagenPreview()">
                                    } @else {
                                    <i class="bi bi-image text-muted"></i>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end mt-5">
                        @if (modoEdicion()) {
                        <div class="d-flex gap-3">
                            <button class="btn btn-cancelar-main" (click)="cancelar()">
                                Cancelar
                            </button>
                            <button class="btn btn-actualizar-main" [style.background-color]="colorSistema"
                                (click)="actualizar()">
                                <i class="bi bi-arrow-repeat"></i> Actualizar
                            </button>
                        </div>
                        } @else {
                        <button class="btn btn-agregar" [style.background-color]="colorSistema"
                            (click)="agregarALista()">
                            <i class="bi bi-plus-lg"></i> Agregar
                        </button>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna Derecha: Lista de Carga -->
        @if (!modoEdicion()) {
        <div class="col-list">
            <div class="card shadow-sm border-0 h-100 d-flex flex-column">
                <div class="card-header bg-white text-center border-0 pt-4">
                    <h2 class="card-title fw-bold">Carga de materia prima</h2>
                </div>
                <div class="card-body p-0 d-flex flex-column">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Producto <i class="bi bi-arrow-down-up ms-1"></i></th>
                                    <th>Present. <i class="bi bi-arrow-down-up ms-1"></i></th>
                                    <th>Stock <i class="bi bi-arrow-down-up ms-1"></i></th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (item of listaCargaPaginada(); track $index) {
                                <tr>
                                    <td class="fw-bold">{{ item.NombreProducto }}</td>
                                    <td>{{ item.NombreUnidad }}</td>
                                    <td>{{ item.Stock }}</td>
                                    <td class="text-center">
                                        <button class="btn-delete" (click)="eliminarDeLista($index)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                } @empty {
                                <tr>
                                    <td colspan="4" class="text-center py-5 text-muted">
                                        La lista de carga está vacía
                                    </td>
                                </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-auto p-4">
                        <div class="d-flex justify-content-end mb-4">
                            <!-- Paginacion Estilo Prototipo -->
                            <div class="pagination-custom">
                                <button class="btn-page" [disabled]="paginaCarga() === 1"
                                    (click)="irAPaginaCarga(paginaCarga() - 1)">
                                    <i class="bi bi-chevron-left"></i>
                                </button>
                                @for (p of [].constructor(totalPaginasCarga()); track $index) {
                                <button class="btn-page" [class.active]="$index + 1 === paginaCarga()"
                                    (click)="irAPaginaCarga($index + 1)">
                                    {{ $index + 1 }}
                                </button>
                                }
                                <button class="btn-page" [disabled]="paginaCarga() === totalPaginasCarga()"
                                    (click)="irAPaginaCarga(paginaCarga() + 1)">
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-3">
                            <button class="btn btn-cancelar-main" (click)="cancelar()">
                                Cancelar
                            </button>
                            <button class="btn btn-guardar-main" [style.background-color]="colorSistema"
                                (click)="guardarTodo()">
                                <i class="bi bi-download"></i> Guardar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        }
    </div>
</div>

<!-- Modales Auxiliares -->
<app-categoria-modal [visible]="mostrarCategoriaModal()" (alCerrar)="mostrarCategoriaModal.set(false)"
    (alGuardar)="cargarCatalogos()">
</app-categoria-modal>

<app-presentacion-modal [visible]="mostrarPresentacionModal()" (alCerrar)="mostrarPresentacionModal.set(false)"
    (alGuardar)="cargarCatalogos()">
</app-presentacion-modal>