<div class="productos-container" [style.--color-sistema]="colorSistema">
    <!-- Header -->
    <div class="productos-header d-flex justify-content-between align-items-center mb-4">
        <!-- Boton Regresar (Solo en edicion) -->
        <button *ngIf="modoEdicion() !== 'lectura'" class="btn btn-regresar" (click)="cancelarEdicion()">
            <i class="bi bi-chevron-left"></i> Regresar
        </button>

        <!-- Boton Exportar (Solo en lectura) -->
        <button *ngIf="modoEdicion() === 'lectura'" class="btn btn-export" [style.background-color]="colorSistema"
            (click)="exportarExcel()">
            <i class="bi bi-file-earmark-spreadsheet"></i> Exportar a Excel
        </button>

        <h2 class="productos-titulo m-0" [style.color]="colorSistema">
            {{ modoEdicion() === 'ajustar' ? 'AJUSTAR INVENTARIO' : (modoEdicion() === 'abastecer' ? 'ABASTECER
            INVENTARIO' : 'LISTADO PRODUCTOS') }}
        </h2>

        <!-- Boton Guardar (Solo en edicion) -->
        <button *ngIf="modoEdicion() !== 'lectura'" class="btn btn-guardar" (click)="guardarCambiosStock()">
            <i class="bi bi-download"></i> Guardar
        </button>

        <!-- Boton Crear (Solo en lectura) -->
        <button *ngIf="modoEdicion() === 'lectura'" class="btn btn-crear" [style.background-color]="colorSistema"
            (click)="crearProducto()">
            <i class="bi bi-plus-circle"></i> Crear producto
        </button>
    </div>

    <!-- Controles de Busqueda -->
    <div class="search-section row g-3 mb-4 align-items-end">
        <div class="col-md-5">
            <label class="form-label fw-bold">Código de producto</label>
            <div class="barcode-search-box shadow-sm">
                <i class="bi bi-upc-scan barcode-icon"></i>
                <input type="text" class="form-control barcode-input" [value]="codigoBarrasBusqueda()"
                    (input)="alCambiarBarras($event)">
            </div>
        </div>

        <div class="col-md-4 offset-md-3">
            <div class="text-search-box shadow-sm">
                <input type="text" class="form-control text-search-input" placeholder="Buscar" [value]="textoBusqueda()"
                    (input)="alCambiarBusqueda($event)">
                <i class="bi bi-search search-icon"></i>
            </div>
        </div>
    </div>

    <!-- Tabla -->
    <div class="products-card card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="table-container p-0 overflow-auto" style="max-height: 480px;">
            <div *ngIf="cargando()" class="text-center py-5">
                <div class="spinner-border" [style.color]="colorSistema" role="status"></div>
                <p class="mt-2 text-muted text-latin">Cargando productos...</p>
            </div>

            <table *ngIf="!cargando()" class="productos-table table table-hover align-middle m-0">
                <thead>
                    <tr>
                        <th class="text-latin">No. <i class="bi bi-arrow-down-up small ms-1"></i></th>
                        <th class="text-latin">Categoría <i class="bi bi-arrow-down-up small ms-1"></i></th>
                        <th class="text-latin">Producto <i class="bi bi-arrow-down-up small ms-1"></i></th>
                        <th class="text-latin" *ngIf="modoEdicion() === 'lectura'">Tipo <i
                                class="bi bi-arrow-down-up small ms-1"></i></th>
                        <th class="text-latin">Unidad <i class="bi bi-arrow-down-up small ms-1"></i></th>
                        <th class="text-latin">Stock <i class="bi bi-arrow-down-up small ms-1"></i></th>
                        <th class="text-latin" *ngIf="modoEdicion() === 'abastecer'">Abastecer <i
                                class="bi bi-arrow-down-up small ms-1"></i></th>
                        <th class="text-latin">Estatus <i class="bi bi-arrow-down-up small ms-1"></i></th>
                        <th class="text-center text-latin">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let producto of productosPaginados(); let i = index"
                        [class.inactive-row]="producto.Estatus === 0">
                        <td class="text-latin">{{ (paginaActual() - 1) * itemsPorPagina + i + 1 | number:'2.0-0' }}</td>
                        <td class="text-latin">{{ producto.NombreCategoria || 'Sin categoria' }}</td>
                        <td class="text-latin">{{ producto.NombreProducto }}</td>
                        <td class="text-latin" *ngIf="modoEdicion() === 'lectura'">
                            <span class="badge" [ngClass]="{
                                'bg-info text-dark': producto.TipoProducto === 'VENTANILLA',
                                'bg-secondary': producto.TipoProducto === 'INSUMO',
                                'bg-warning text-dark': producto.TipoProducto === 'COCINA',
                                'bg-primary': producto.TipoProducto === 'AMBOS'
                            }">
                                {{ producto.TipoProducto || 'N/A' }}
                            </span>
                        </td>
                        <td class="td-unidad text-latin">{{ producto.NombreUnidad || 'Unidad' }}</td>
                        <td class="text-latin">
                            <ng-container *ngIf="modoEdicion() !== 'ajustar'">
                                <span [ngClass]="{'text-danger fw-bold': (producto.Stock || 0) <= 0}">
                                    {{ (producto.Stock || 0) === 0 ? '0' : producto.Stock }}
                                </span>
                            </ng-container>
                            <input *ngIf="modoEdicion() === 'ajustar'" type="number"
                                class="form-control form-control-sm stock-input"
                                [value]="cambiosPendientes()[producto.CodigoProducto || 0] || 0"
                                (input)="alCambiarValorStock(producto.CodigoProducto, $any($event.target).value)">
                        </td>
                        <td class="text-latin" *ngIf="modoEdicion() === 'abastecer'">
                            <input type="number" class="form-control form-control-sm stock-input"
                                [value]="cambiosPendientes()[producto.CodigoProducto || 0] || ''" placeholder="-"
                                (input)="alCambiarValorStock(producto.CodigoProducto, $any($event.target).value)">
                        </td>
                        <td class="text-latin">
                            <span class="badge rounded-pill px-3"
                                [style.color]="producto.Estatus === 1 ? 'green' : 'red'"
                                [style.backgroundColor]="producto.Estatus === 1 ? 'rgba(0,128,0,0.1)' : 'rgba(255,0,0,0.1)'">
                                {{ producto.Estatus === 1 ? 'Activo' : 'Inactivo' }}
                            </span>
                        </td>
                        <td class="acciones-cell text-center">
                            <button class="btn-accion btn-editar" [disabled]="modoEdicion() !== 'lectura'"
                                (click)="editarProducto(producto)" title="Editar">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button class="btn-accion btn-eliminar" [disabled]="modoEdicion() !== 'lectura'"
                                (click)="eliminarProducto(producto.CodigoProducto)" title="Eliminar">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                    <tr *ngIf="productosPaginados().length === 0">
                        <td [attr.colspan]="modoEdicion() === 'abastecer' ? 8 : (modoEdicion() === 'lectura' ? 8 : 7)"
                            class="text-center py-4 text-muted">No se encontraron productos</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Footer con Paginacion y Acciones de Stock -->
    <div class="productos-footer d-flex align-items-center justify-content-between mt-4">
        <div class="pagination-info text-muted small text-latin">
            Mostrando <strong>{{ rangoInicio() }}</strong> al <strong>{{ rangoFin() }}</strong> de <strong>{{
                totalRegistros() }}</strong> registros
        </div>

        <!-- Botoneras de Stock -->
        <div class="stock-actions d-flex gap-4">
            <button class="btn btn-stock" [style.background-color]="colorSistema" (click)="ajustarStock()">
                <i class="bi bi-gear-fill"></i> Ajustar
            </button>
            <button class="btn btn-stock" [style.background-color]="colorSistema" (click)="abastecerStock()">
                <i class="bi bi-box-seam-fill"></i> Abastecer
            </button>
        </div>

        <!-- Paginacion -->
        <nav aria-label="Navegacion" class="pagination-nav">
            <ul class="pagination pagination-sm m-0">
                <li class="page-item" [class.disabled]="paginaActual() === 1">
                    <button class="page-link" (click)="paginaAnterior()"><i class="bi bi-chevron-left"></i></button>
                </li>
                <li class="page-item" *ngFor="let p of [].constructor(totalPaginas()); let i = index"
                    [class.active]="paginaActual() === i + 1">
                    <button class="page-link" (click)="irAPagina(i + 1)"
                        [style.background-color]="paginaActual() === i + 1 ? colorSistema : ''"
                        [style.border-color]="paginaActual() === i + 1 ? colorSistema : ''">
                        {{ i + 1 }}
                    </button>
                </li>
                <li class="page-item" [class.disabled]="paginaActual() === totalPaginas() || totalPaginas() === 0">
                    <button class="page-link" (click)="paginaSiguiente()"><i class="bi bi-chevron-right"></i></button>
                </li>
            </ul>
        </nav>
    </div>
</div>